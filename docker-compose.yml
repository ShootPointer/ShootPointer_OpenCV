version: "3.9"

services:
  fast-api:
    build: .
    container_name: fast-api
    ports:
      - "8000:8000"
    # .env 값을 기본으로 쓰고, 아래 environment로 최소 기본값만 보강
    env_file:
      - .env
    environment:
      # 저장/정적 URL/Redis (여기 값은 기본값; .env에서 덮어쓸 수 있음)
      - SAVE_ROOT=/data/highlights
      - STATIC_BASE_URL=http://localhost:8000/static/highlights
      - REDIS_URL=redis://redis:6379/0

      # FFmpeg drawtext 기본 폰트(컨테이너 내 경로)
      - DRAW_FONTFILE=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf
      # Shorts 세로 해상도/인코딩 기본값(필요 시 .env로 오버라이드)
      - SHORTS_WIDTH=1080
      - SHORTS_HEIGHT=1920
      - FFMPEG_PRESET=veryfast
      - FFMPEG_CRF=20
      - FFMPEG_ABR=128k

      # 탐지/튜닝(필요 시 .env에서 조정)
      - SCALE_BASE=960
      - BALL_HSV_MIN=5,60,60
      - BALL_HSV_MAX=25,255,255

      # 로그 레벨 기본
      - LOG_LEVEL=INFO

    volumes:
      # SAVE_ROOT=/data/highlights 매핑 (호스트에 결과 저장)
      - ./data/highlights:/data/highlights
    depends_on:
      redis:
        condition: service_started
    restart: unless-stopped
    # (Linux에서 호스트 네트워크로 콜백/접근 필요하면 주석 해제)
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    # 간단 헬스체크(선택): redis-cli가 없으면 제거해도 됨
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
