services:
  fast-api:
    build: .
    container_name: fast-api
    ports:
      - "8000:8000"   # FastAPI는 외부 8000 유지
    env_file:
      - .env
    environment:
      # 기본값(필요시 .env에서 덮어씀)
      - SAVE_ROOT=/data/highlights
      - STATIC_BASE_URL=http://tkv00.ddns.net:8000/static/highlights
      - REDIS_URL=redis://redis:6379/0

      - DRAW_FONTFILE=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf
      - SHORTS_WIDTH=1080
      - SHORTS_HEIGHT=1920
      - FFMPEG_PRESET=veryfast
      - FFMPEG_CRF=20
      - FFMPEG_ABR=128k

      - SCALE_BASE=960
      - BALL_HSV_MIN=5,60,60
      - BALL_HSV_MAX=25,255,255

      - LOG_LEVEL=INFO

    volumes:
      - ./data/highlights:/data/highlights
    depends_on:
      redis:
        condition: service_healthy   # Redis 준비되면 기동
    networks: [app-net]
    restart: unless-stopped
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

  redis:
    image: redis:7-alpine
    container_name: redis
    # ❌ 호스트 포트 노출 제거 (6379 충돌 방지)
    # ports:
    #   - "6379:6379"
    networks: [app-net]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p 6379 ping || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

networks:
  app-net:
    driver: bridge
