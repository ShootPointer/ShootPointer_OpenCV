version: "3.9"

services:
  fast-api:
    build: .
    container_name: fast-api
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      REDIS_URL: redis://host.docker.internal:6379/0
    volumes:
      - /mnt/highlights:/data/highlights   # ← NFS 마운트 지점 사용
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      app-net: {}   # ← 리스트가 아니라 매핑!

  ai_worker:
    build:
      context: ./ai_worker
      dockerfile: Dockerfile
    container_name: ai_worker_simulator
    environment:
      REDIS_URL: redis://host.docker.internal:6379/0
      SPRING_API_URL: http://host.docker.internal:8080/api/v1/jobs
      OUTPUT_DIR: /data/highlights/processed
      PROGRESS_CHANNEL_PREFIX: opencv-progress-highlight
      REDIS_AI_JOB_QUEUE: opencv-ai-job-queue
      PYTHONPATH: /app:/app/ai_worker   # ← ai_modules 등 패키지 인식 보강
    volumes:
      - /mnt/highlights:/data/highlights   # ← NFS 마운트 지점 사용
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: on-failure
    networks:
      app-net: {}   # ← 매핑

networks:
  app-net:
    driver: bridge
